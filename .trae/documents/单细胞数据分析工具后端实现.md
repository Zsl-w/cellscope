# 单细胞数据分析工具后端实现计划

## 1. 项目结构设计

### 1.1 目录结构
```
backend/
├── main.py                 # 应用入口
├── requirements.txt        # 依赖列表
├── core/                   # 核心配置
│   ├── config.py           # 配置管理
│   └── database.py         # 数据库连接
├── api/                    # API路由
│   ├── __init__.py
│   ├── auth.py             # 认证相关
│   ├── projects.py         # 项目管理
│   ├── uploads.py          # 文件上传
│   ├── analysis.py         # 分析流程
│   └── results.py          # 结果导出
├── models/                 # 数据模型
│   ├── __init__.py
│   ├── user.py             # 用户模型
│   ├── project.py          # 项目模型
│   ├── upload.py           # 上传文件模型
│   └── analysis.py         # 分析结果模型
├── schemas/                # 数据验证
│   ├── __init__.py
│   ├── user.py             # 用户相关
│   ├── project.py          # 项目相关
│   ├── upload.py           # 上传相关
│   └── analysis.py         # 分析相关
├── services/               # 业务逻辑
│   ├── __init__.py
│   ├── auth.py             # 认证服务
│   ├── upload.py           # 文件处理
│   └── analysis.py         # 分析引擎
└── utils/                  # 工具函数
    ├── __init__.py
    └── security.py         # 安全相关
```

## 2. 核心功能实现

### 2.1 基础配置（core/）
- **config.py**：使用Pydantic Settings管理配置
- **database.py**：SQLAlchemy ORM配置，SQLite数据库

### 2.2 数据模型（models/）
- **user.py**：用户模型，包含邮箱、密码哈希、免费额度
- **project.py**：项目模型，包含名称、描述、状态、关联用户
- **upload.py**：上传文件模型，包含文件路径、类型、大小、关联项目
- **analysis.py**：分析结果模型，包含QC结果、降维结果、聚类结果

### 2.3 API路由（api/）
- **auth.py**：登录、注册、获取当前用户
- **projects.py**：创建、获取、列表、删除项目
- **uploads.py**：上传文件、获取项目文件、删除文件
- **analysis.py**：质控、标准化、降维、聚类
- **results.py**：获取分析结果、导出结果

### 2.4 业务逻辑（services/）
- **auth.py**：JWT令牌生成、密码哈希验证
- **upload.py**：文件上传处理、格式验证
- **analysis.py**：使用Scanpy实现单细胞分析流程

## 3. 详细实现计划

### 3.1 环境搭建
1. 创建requirements.txt，包含所需依赖
2. 初始化FastAPI应用
3. 配置CORS和中间件

### 3.2 数据库与模型
1. 创建SQLAlchemy数据库连接
2. 实现用户、项目、上传、分析结果模型
3. 创建数据库表结构

### 3.3 认证系统
1. 实现JWT认证中间件
2. 实现密码哈希与验证
3. 实现登录、注册API
4. 实现获取当前用户API

### 3.4 项目管理
1. 实现项目创建API
2. 实现项目列表API
3. 实现项目详情API
4. 实现项目删除API

### 3.5 文件上传
1. 实现文件上传API，支持10x Genomics和H5AD格式
2. 实现文件列表API
3. 实现文件删除API
4. 实现文件格式验证

### 3.6 分析引擎
1. 实现数据质控API
2. 实现标准化API
3. 实现PCA降维API
4. 实现UMAP降维API
5. 实现Louvain/Leiden聚类API
6. 实现差异表达分析API

### 3.7 结果导出
1. 实现结果获取API
2. 实现图表导出API
3. 实现数据表格导出API
4. 实现分析报告生成API

## 4. 技术栈

### 4.1 基础框架
- **FastAPI**：高性能API框架
- **SQLAlchemy**：ORM数据库操作
- **Pydantic**：数据验证

### 4.2 分析库
- **Scanpy**：单细胞数据分析
- **UMAP-learn**：UMAP降维
- **Leidenalg**：Leiden聚类
- **Pandas**：数据处理
- **NumPy**：数值计算

### 4.3 安全
- **JWT**：令牌认证
- **Bcrypt**：密码哈希

### 4.4 数据库
- **SQLite**：轻量级数据库

## 5. 关键API设计

### 5.1 认证API
- `POST /api/auth/token`：登录获取令牌
- `POST /api/auth/register`：用户注册
- `GET /api/auth/me`：获取当前用户

### 5.2 项目API
- `POST /api/projects`：创建项目
- `GET /api/projects`：获取项目列表
- `GET /api/projects/{id}`：获取项目详情
- `DELETE /api/projects/{id}`：删除项目

### 5.3 上传API
- `POST /api/uploads/{project_id}/files`：上传文件
- `GET /api/uploads/{project_id}/files`：获取项目文件
- `DELETE /api/uploads/files/{id}`：删除文件

### 5.4 分析API
- `GET /api/analysis/{project_id}/qc`：获取质控结果
- `POST /api/analysis/{project_id}/qc`：执行质控
- `POST /api/analysis/{project_id}/normalize`：执行标准化
- `POST /api/analysis/{project_id}/pca`：执行PCA
- `POST /api/analysis/{project_id}/umap`：执行UMAP
- `POST /api/analysis/{project_id}/cluster`：执行聚类

### 5.5 结果API
- `GET /api/results/{project_id}`：获取分析结果
- `POST /api/results/{project_id}/export`：导出结果

## 6. 测试计划

1. 单元测试：测试核心功能
2. 集成测试：测试API流程
3. 性能测试：测试大数据处理性能
4. 功能测试：测试完整分析流程

## 7. 部署计划

1. 使用uvicorn运行FastAPI应用
2. 配置环境变量
3. 设置日志记录
4. 配置监控与告警

通过以上实现，将完成一个完整的单细胞数据分析工具后端，支持前端所需的所有功能，包括用户认证、项目管理、文件上传、单细胞分析和结果导出。